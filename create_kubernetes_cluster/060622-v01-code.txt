pipeline {
    agent any
    stages {
       stage('clonerepo'){
           steps {
               script{
                   try{
                   sh 'rm -rfv *'   
                   dir('gcp_devops_code'){
                   git branch: 'main', changelog: false, credentialsId: 'git_credentials', poll: false, url: 'https://github.com/di-devops-poc/gcp-devops-code'
                   }
                  }
                  catch(err){
                      echo err.getMessage();
                      error('Error!!!')
                      
                  }
                }
            }
        }
        stage('creatingcluster'){
            steps{
                
                    script{
                               try{
                                        dir('gcp_devops_code/create_cluster')
                                        {
//				                            sh 'chmod 777 ${WORKSPACE}/gcp_devops_code/configfile'
				                            sh 'bash ${WORKSPACE}/gcp_devops_code/devops_shell_scripts/update_gcp_region_project_in_tf.sh ${WORKSPACE}'
				                            sh 'terraform init'
				                            sh 'terraform plan -lock=false'
				                            sh 'terraform apply --auto-approve -lock=false'
				                        }
                                   }
                                catch(err){
                                        echo err.getMessage();
                                        error('Error!!!')
                                        }   
                        }
                }
        }
        
    }
}
